version: "3.8"

services:
  samba:
    image: dperson/samba
    container_name: samba
    restart: always
    command: |
      {% for user in SAMBA -%}
      -u "{{ user.USER }};{{ user.PASS }}"
      -s "{{ user.USER }};/{{ user.USER }};yes;no"
      {% endfor -%}
      -s "Media;/Media;yes;no"
      -s "Downloads;/Downloads;yes;no"
      -s "TimeMachine;/TimeMachine;yes;no"
    stdin_open: true
    tty: true
    environment:
      - TZ={{ TIMEZONE }}
    ports:
      - 139:139
      - 445:445
    volumes:
      - {{ STORAGE }}/Media:/Media
      - {{ STORAGE }}/Media/Downloads:/Downloads
      - {{ DRIVES[1]['MOUNT'] }}:/TimeMachine
      {% for user in SAMBA -%}
      - {{ STORAGE }}/files/{{ user.USER }}:/files/{{ user.USER }}
      {% endfor %}

  plex:
    image: jaymoulin/plex:latest
    container_name: plex
    hostname: plex
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID={{ PUID }}
      - PGID={{ PGID }}
      - VERSION=docker
      - TZ={{ TIMEZONE }}
    volumes:
      - {{ STORAGE }}/docker/Plex Media Server:/root/Library/Application Support/Plex Media Server
      - {{ STORAGE }}/Media:/media

  transmission:
    image : jaymoulin/transmission:4.0.4-arm64v8
    container_name: transmission
    restart: unless-stopped
    command: transmission-daemon -f -g /config
    volumes:
      - {{ STORAGE }}/docker/transmission:/config
      - {{ STORAGE }}/Media/Downloads:/Downloads
    ports:
      - 9091:9091
      - 51413:51413
      - 51413:51413/udp
    expose:
      - 9091

  flexget:
    image: wiserain/flexget:3.7.7
    container_name: flexget
    restart: unless-stopped
    volumes:
      - {{ STORAGE }}/docker/flexget:/config
      - {{ STORAGE }}/docker/flexget/custom-cont-init.d:/custom-cont-init.d
      - {{ STORAGE }}/Media/Downloads:/Downloads
      - {{ STORAGE }}/Media:/storage
    ports:
      - 5050:5050
    environment:
      - PUID={{ PUID }}
      - PGID={{ PGID }}
      - TORRENT_PLUGIN=transmission
      - FG_WEBUI_PASSWD={{ FLEXGET_PASS }}
    links:
      - transmission
